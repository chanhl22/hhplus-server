# 시퀀스 다이어그램

## 1. 잔액 충전 / 조회 API
### 1-1. 사용자 식별자 및 충전할 금액을 받아 잔액을 충전합니다.
```mermaid
sequenceDiagram
    사용자->>+포인트: [금액 > 0] 충전 요청
    activate 포인트
    포인트->>포인트: 금액 충전
    포인트-->>-사용자: 충전 성공
```

<br>

### 1-2. 사용자 식별자를 통해 해당 사용자의 잔액을 조회합니다.
```mermaid
sequenceDiagram
    사용자->>+포인트: 잔액 조회
    activate 포인트
    포인트-->>-사용자: 잔액 반환
```

<br>

## 2. 상품 조회 API
### 2-1. 상품 정보 ( ID, 이름, 가격, 잔여수량 ) 을 조회합니다.
```mermaid
sequenceDiagram
    상품->>상품: 상품 정보 조회
    상품->>+재고: 잔여 수량 조회
    
    alt 재고가 없음
        재고->>상품: 예외 발생 (재고 없음)
    else 재고가 있음
        재고-->>-상품: 잔여 수량 반환
    end
```

<br>

## 3. 선착순 쿠폰 기능
### 3-1. 사용자는 선착순으로 쿠폰을 발급받을 수 있어야 합니다.
```mermaid
sequenceDiagram
    사용자->>+쿠폰: 쿠폰 발급 요청
    
    alt 쿠폰이 없음
        쿠폰->>사용자: 예외 발생 (쿠폰 소진)
    else 쿠폰이 있음
        쿠폰-->>-사용자: 쿠폰 발급 완료
    end
```

<br>

### 3-2. 발급된 쿠폰 목록을 조회할 수 있어야 합니다.
```mermaid
sequenceDiagram
    사용자->>+쿠폰: 내 쿠폰 목록 조회 요청
    쿠폰-->>-사용자: 쿠폰 목록 반환
```

<br>

### 3-3. 주문 시 유효한 쿠폰을 제출하면 전체 주문 금액에 대해 할인이 적용되어야 합니다.
```mermaid
sequenceDiagram
    주문->>+쿠폰: 쿠폰 검증 요청
    쿠폰->>쿠폰: 쿠폰 유효성 확인

    alt 쿠폰이 유효하지 않음
        쿠폰->>주문: 예외 발생 (쿠폰이 유효하지 않음)
    else 쿠폰이 유효함
        쿠폰->>-주문: 쿠폰 유효 응답
        주문->>주문:할인 적용
    end
```

<br>

## 4. 주문 / 결제 API
### 4-1. 사용자는 (상품 ID, 수량) 목록을 입력하여 주문할 수 있어야 합니다.
```mermaid
sequenceDiagram
    사용자->>+주문: 주문 요청
    activate 주문

    loop 각 상품에 대해
        주문->>+상품: 상품 조회
        activate 상품
        상품->>+재고: 재고 확인 요청
        alt 재고 부족
            재고->>상품: 예외 발생 (재고 부족)
            상품-->>-주문: 주문 목록에서 제외
        else 재고 충분
            재고-->>-상품: 재고 확인 완료
            상품-->>-주문: 주문 가능
        end
    end

    alt 주문 가능한 상품 존재
        주문->>주문: 재고 차감
        주문-->>사용자: 주문 성공 응답
    else 모든 상품 재고 부족
        주문-->>사용자: 주문 실패 응답
    end

    deactivate 주문
   
    
---
sequenceDiagram
    activate 주문

    loop 각 상품에 대해
        주문->>+상품: 상품 조회
        activate 상품
        상품->>+재고: 재고 확인 요청
        alt 재고 부족
            재고->>상품: 예외 발생 (재고 부족)
            상품-->>-주문: 주문 목록에서 제외
        else 재고 충분
            재고-->>-상품: 재고 확인 완료
            상품-->>-주문: 주문 가능
        end
    end

    alt 주문 가능한 상품 존재
        주문->>주문: 재고 차감
        주문->>결제: 결제 요청
    end

    deactivate 주문
```

<br>

### 4-2. 주문 시 결제는 기존에 충전된 잔액을 사용하여 수행합니다. 결제 성공 시 잔액이 차감되어야 합니다.
```mermaid
sequenceDiagram
    주문->>+결제: 결제 요청
    
    activate 결제

    결제->>+사용자: 잔액 확인 요청
    사용자->>+포인트: 잔액 조회
    포인트-->>-사용자: 잔액 반환
    사용자-->>-결제: 잔액 응답

    결제->>결제: 총 주문 금액과 잔액 비교

    alt 잔액 부족
        결제->>주문: 예외 발생 (잔액 부족)
    else 잔액 충분
        결제->>사용자: 결제 요청
        activate 사용자
        사용자->>포인트: 잔액 차감 요청
        activate 포인트
        포인트-->>-사용자: 잔액 차감 완료 응답
        사용자-->>-결제: 결제 완료 응답
        결제-->>-주문: 결제 완료 응답
    end
    
    deactivate 결제
```

<br>

### 4-3. 결제 성공 시 주문 정보를 외부 데이터 플랫폼으로 전송합니다.
```mermaid
sequenceDiagram
    결제->>+외부 데이터 플랫폼: [결제 성공 시]주문 정보 전송
    외부 데이터 플랫폼-->>-결제: 데이터 수신 완료
```

<br>

## 5. 상위 상품 조회 API
### 5-1. 최근 3일간 가장 많이 팔린 상위 5개 상품 정보를 제공합니다.
```mermaid
sequenceDiagram
     Note over 배치프로세스: 매일 실행 (스케줄링)

    배치프로세스->>+주문: 최근 3일간 주문 조회
    주문->>+결제: 결제 성공 주문 필터링
    결제-->>-주문: 결제 완료 주문 목록 반환
    주문-->>-배치프로세스: 결제 완료된 주문 목록 반환

    배치프로세스->>+상품통계저장소: 상품별 판매량 집계 후 저장
    상품통계저장소-->>-배치프로세스: 저장 완료

    actor Client as Actor
    Note over Client: API 요청

    Client->>+상품통계저장소: 인기 상품 조회
    상품통계저장소-->>-Client: 상위 5개 상품 응답
```