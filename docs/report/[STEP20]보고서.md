# 🧾 장애 보고서: Redis 장애로 인한 분산락 실패

---

## 1. 장애 요약

- **장애명**: Redis 장애로 인한 분산락 미작동 → 주문 중복 처리 및 데이터 충돌
- **장애 일시**: 2025년 6월 5일(수) 10:22 ~ 11:35 (약 1시간 13분)
- **장애 상태**: 종료됨 (복구 완료)
- **서비스 영향도**:
    - 상품 재고 차감 로직에서 분산락 미작동 → 재고 음수 발생
    - 쿠폰 중복 발급 및 포인트 중복 차감 사례 다수 발생
    - 총 108건 중복 주문 처리 발생
- **장애 등급**: S1 (Critical)

## 2. 장애 원인 요약

Redis 단일 노드에 메모리 과부하(OOM) 발생 → 프로세스 종료 → 분산락 미작동 → 동시성 제어 실패로 인해 재고/쿠폰/포인트 처리 중복 발생

## 3. 장애 상세 타임라인

| 시간 | 내용                                  |
| --- |-------------------------------------|
| 10:22 | Redis 연결 오류 다수 발생 (connection refused) |
| 10:24 | 분산락 기반 상품/쿠폰/포인트 처리 로직에서 예외 다수 발생   |
| 10:28 | 주문 중복 및 재고 음수 현상 확인                 |
| 10:31 | Redis 단일 노드 다운 확인 (OOM + 프로세스 비정상 종료) |
| 10:37 | Redis 재기동 시도, 실패                    |
| 10:42 | 임시 메모리 기반 로컬 락 적용으로 일부 트랜잭션 보호 시작   |
| 10:55 | Redis 환경 긴급 조치 후 복원 시작              |
| 11:20 | 신규 주문 정상화 시작                        |
| 11:35 | 전체 서비스 정상화 확인, 인시던트 종료 선언           |

## 4. 장애 영향 분석

| 항목 | 영향 |
| --- | --- |
| 중복 주문 수 | 108건 |
| 재고 음수 발생 상품 | 34개 |
| 직접 매출 영향 | 약 XXX만 원 추정 |
| 고객센터 문의 | 37건 접수 (주문 오류, 재고 없음 등) |

## 5. 5 Whys 분석

| Why 단계 | 내용 |
| --- | --- |
| 1. 왜 주문 중복/재고 오류가 발생했는가? | 분산락이 작동하지 않아 동시에 여러 요청이 처리되었음 |
| 2. 왜 분산락이 작동하지 않았는가? | Redis 인스턴스가 다운되어 연결 실패 발생 |
| 3. 왜 Redis가 다운되었는가? | OOM(Out Of Memory)으로 인한 프로세스 종료 |
| 4. 왜 메모리가 과도하게 사용되었는가? | 만료되지 않은 세션/락 키의 지속적 누적 발생 |
| 5. 왜 만료 정책이 관리되지 않았는가? | 자동 만료 TTL 설정 누락 및 주기적 삭제 정책 미적용 |

## 6. 장애 대응 및 복구 조치

1. **장애 감지 및 알림**
    - Redis 메모리 사용량 급증으로 인한 OOM 경고 발생 (Redis maxmemory limit 초과)
    - 분산락 획득 실패가 급증하며 서비스 API 에러율 상승 감지 (APM, 로그 기반 경보 동시 발생)
    - 장애 감지 후 **장애 티켓 자동 생성** 및 **인시던트 룸(Slack 채널) 개설**
        - 참여: 백엔드 개발팀, 인프라팀, QA, 운영 팀
2. **원인 파악 및 1차 진단**
    - Redis 인스턴스 상태 점검 → OOM command not allowed 다수 발생
    - keys 수 확인 시, 분산락 키 및 일부 캐시 키가 과도하게 유지됨을 확인
    - TTL 누락 또는 비정상 해제로 인한 키 누적이 주요 원인으로 파악됨
- 1차 복구 시도 (실패)
    - Redis 프로세스 재시작 시도 → 재시작 직후 동일 오류로 재중단
    - 메모리 확보 위해 flushdb 등 강제 조치 논의되었으나, 데이터 보호 이슈로 중단
- **임시 대응 조치**
    - 각 도메인 서비스(API 서버) 내에서 분산락 미작동 시, **로컬 락(synchronized)으로 대체 적용**
        - 우선 적용 대상: 재고 차감, 주문 생성 로직
        - 일부 트랜잭션 지연 발생하였으나, 중복 요청 완화에는 효과 있음
    - 락 미보장 도메인(쿠폰, 포인트)은 일시적으로 해당 기능 사용 제한
- **Redis 환경 긴급 조치**
    - TTL 누락 키 정리: 위험도가 낮은 prefix 키 중심으로 SCAN + DEL 수행
    - 서비스 코드 Hotfix: 락 키 및 캐시 키 TTL 적용 누락 부분 즉시 패치 배포
    - Redis 재기동 → 정상화 확인
- **서비스 정상화 및 후속 처리**
    - API 오류율 및 응답시간 지표 회복 확인
    - 서비스 완전 정상화 공지 및 인시던트 룸 종료
    - 중복 처리된 **주문, 쿠폰, 포인트 이력**을 기준으로 **정합성 검증 및 정리용 배치 수행**
        - 주문 중복건 → 자동 취소 및 사용자 알림 발송
        - 포인트 중복 차감 → 복구 및 로그 기록

## 7. 장애 전파 전략

- **전파 시점**: Redis 다운 10분 후, 전체 유관 부서에 공지
- **전파 내용**:
    - “현재 일부 주문 서비스에서 중복 요청이 발생할 수 있으며, 원인은 내부 분산락 시스템(Redis 기반) 장애입니다. 장애 복구를 진행 중이며 신규 주문은 일시 중단 요청드립니다.”
        - 엔지니어 버전

          > 주문 서비스의 Redis 연결이 끊어져 분산락 동작에 실패하고 있습니다. 이로 인해 일부 주문 요청에서 중복 처리 및 데이터 충돌이 발생 중이며, 장애 영향 범위는 주문 처리 API 전체입니다. Redis 복구를 시도 중이며, 약 10분 내로 정상화될 것으로 보입니다.
        
        - 기획자 버전

          > 현재 주문 서비스에 일시적인 장애가 발생하여 일부 사용자의 주문이 중복 처리되거나 실패할 수 있습니다. 내부 시스템에서 주문 처리 안정성을 위한 핵심 구성 요소(Redis)에 문제가 발생하여 복구 작업을 진행하고 있으며, 약 10분 내로 정상화될 예정입니다. 서비스 이용에 불편을 드려 죄송합니다.

## 8. 재발 방지 대책

### 8-1. Redis 장애 시 fallback 로직 여부 및 대응 내역

#### 📌 장애 시점에 fallback 대응이 있었는가?

- **부분적으로만 존재함**
- `쿠폰 발급`, `포인트 차감/적립`은 Redis 기반 분산락 실패 시 처리 자체가 **바로 실패**하도록 구현되어 있었음 → fallback **없음**
- `상품 재고 차감` 로직에는 **임시로 로컬 락 (JVM synchronized)** 을 사용하는 fallback 로직이 부분 적용되어 있었음 → **일부 동시성 제어 가능했으나 완전하지 않음**

#### 📌 장애 시점에 TTL 설정이 있었는가?

- Redis 메모리 임계치를 초과하여 OOM(Out of Memory) 발생
- TTL 미설정 또는 과도한 TTL로 인해 **분산락 키와 기타 캐시 키가 무제한 축적**됨
- 이로 인해 **락 획득 불가**, 서비스 지연 및 예외 빈발

### 8-2. 후속 대응 방안 (TTL & Fallback 기준 강화)

#### 🟡 Short-Term (1주 내)

- [ ]  **모든 분산락 키에 TTL 강제 설정 (최대 10초 이내)**
- [ ]  기존 분산락 코드에 TTL 누락 여부 자동 점검 로직 추가
- [ ]  Redis 메모리 사용량 임계치 알림 및 TTL 모니터링 대시보드 구성
- [ ]  Redis 장애 시 락 실패 → 예외가 아닌 락 실패 → 로컬 락 대체 구조 적용 (우선순위 낮은 트랜잭션부터)
- [ ]  서비스별 fallback 적용 여부 점검 및 표준화 체크리스트 마련
- [ ]  락 획득 실패 시 fallback 가능한 도메인부터 orElseLocalLock() 적용

#### 🟠 Mid-Term (1개월 내)

- [ ]  **공통 락 유틸에 TTL 및 fallback 기본값 설정 강제화**
- [ ]  TTL 기반 락의 해제 누락 방지를 위한 트랜잭션 종료 후 자동 릴리즈 구조 적용
- [ ]  Redis Keyspace notification 기반으로 락 누수 탐지 시스템 구현
- [ ]  락 획득 실패 시에도 예외를 발생시키지 않고 큐잉 처리 또는 지연 재시도 전략 도입

#### 🔵 Long-Term (분기 내)

- [ ]  락 의존성 높은 트랜잭션을 대상으로 **락-리스(lock-less)** 구조 리팩토링 검토 (이벤트 큐, SAGA 패턴, DB 낙관적 락 전환 등)
- [ ]  Redisson 기반 고가용 락 구현 시 fallback 로직 포함한 공통 인터페이스 설계 (LockStrategy, FallbackPolicy)