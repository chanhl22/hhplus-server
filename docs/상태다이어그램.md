# 시퀀스 다이어그램

## 1. 잔액 충전 / 조회 API
### 1-1. 사용자 식별자 및 충전할 금액을 받아 잔액을 충전합니다.
```mermaid
stateDiagram-v2
    [*] --> 충전요청: 잔액 충전 요청
    
    충전요청 --> 검증: 사용자가 존재하는가?
    검증 --> 충전실패: 사용자 없음

    검증 --> 금액검증: 충전 금액이 양수인가?
    금액검증 --> 충전실패: 금액이 0 이하
    충전실패 --> [*]: 충전 실패

    금액검증 --> 충전진행: 포인트 충전
    충전진행 --> 반영: 잔액 업데이트
    반영 --> 충전완료: 충전 성공
    충전완료 --> [*]: 충전 완료
```

<br>

### 1-2. 사용자 식별자를 통해 해당 사용자의 잔액을 조회합니다.
```mermaid
stateDiagram-v2
    [*] --> 잔액조회: 사용자 잔액 조회 요청
    
    잔액조회 --> 검증: 사용자가 존재하는가?
    검증 --> 조회실패: 사용자 없음
    조회실패 --> [*]: 조회 실패

    검증 --> 잔액확인: 잔액이 존재하는가?
    잔액확인 --> 반환0: 잔액 없음 (0 반환)
    반환0 --> [*]: 조회 완료

    잔액확인 --> 반환잔액: 잔액 존재 (현재 잔액 반환)
    반환잔액 --> [*]: 조회 완료
```

<br>

## 2. 상품 조회 API
### 2-1. 상품 정보 ( ID, 이름, 가격, 잔여수량 ) 을 조회합니다.
```mermaid
stateDiagram-v2
    [*] --> 상품조회: 상품 정보 조회 요청
    
    상품조회 --> 상품검증: 상품이 존재하는가?
    상품검증 --> 조회실패: 상품 없음

    상품검증 --> 판매상태검증: 상품이 단종 또는 판매 중지 상태인가?
    판매상태검증 --> 조회실패: 단종 또는 판매 중지됨
    조회실패 --> [*]: 조회 불가

    판매상태검증 --> 재고조회: 잔여 수량 확인
    재고조회 --> 조회실패: 재고 없음
    재고조회 --> 상품반환: 상품 정보 반환 (ID, 이름, 가격, 잔여수량)
    상품반환 --> [*]: 조회 완료
```

<br>

## 3. 선착순 쿠폰 기능
### 3-1. 사용자는 선착순으로 쿠폰을 발급받을 수 있어야 합니다.
```mermaid
stateDiagram-v2
    [*] --> 쿠폰발급요청: 쿠폰 발급 요청
    
    쿠폰발급요청 --> 선착순검증: 남은 쿠폰 수 확인
    선착순검증 --> 발급실패: 쿠폰 수량 초과

    선착순검증 --> 중복검증: 사용자가 해당 쿠폰을 이미 발급받았는가?
    중복검증 --> 발급실패: 중복 발급 불가
    발급실패 --> [*]: 발급 불가

    중복검증 --> 예외검증: 특정 이벤트 쿠폰인가? (특정 이벤트에서는 여러 장 허용 가능)
    중복검증 --> 발급진행: 정상 발급 가능
    예외검증 --> 발급진행: 여러 장 허용 (예외 적용)

    발급진행 --> 쿠폰반영: 사용자의 쿠폰 정보 업데이트
    쿠폰반영 --> 발급완료: 쿠폰 발급 성공
    발급완료 --> [*]: 발급 완료
```

<br>

### 3-2. 발급된 쿠폰 목록을 조회할 수 있어야 합니다.
```mermaid
stateDiagram-v2
    [*] --> 쿠폰조회요청: 쿠폰 목록 조회 요청
    
    쿠폰조회요청 --> 본인확인: 사용자 본인의 쿠폰인가?
    본인확인 --> 조회실패: 다른 사용자 쿠폰 요청
    조회실패 --> [*]: 조회 불가

    본인확인 --> 필터적용: 필터 옵션 확인 (미사용 여부, 만료 여부)
    
    필터적용 --> 미사용필터: 미사용 쿠폰만 조회 옵션 적용
    미사용필터 --> 만료필터: 만료 쿠폰 필터링 여부 확인
    필터적용 --> 조회결과반환: 필터 없음

    만료필터 --> 조회결과반환: 최종 쿠폰 목록 반환
    조회결과반환 --> [*]: 조회 완료
```

<br>

### 3-3. 주문 시 유효한 쿠폰을 제출하면 전체 주문 금액에 대해 할인이 적용되어야 합니다.
```mermaid
stateDiagram-v2
    [*] --> 주문요청: 주문 요청
    
    주문요청 --> 쿠폰검증: 쿠폰이 제출되었는가?
    쿠폰검증 --> 할인적용: 쿠폰 있음
    쿠폰검증 --> [*]: 쿠폰 없음 (할인 없음)

    할인적용 --> 유효성검증: 쿠폰이 유효한가? (미사용 & 유효기간 체크)
    유효성검증 --> 적용실패: 유효하지 않은 쿠폰
    적용실패 --> [*]: 할인 없이 주문 진행

    유효성검증 --> 할인계산: 할인 금액 적용
    할인계산 --> [*]: 최종 결제 금액 반영
```

<br>

## 4. 주문 / 결제 API
### 4-1. 사용자는 (상품 ID, 수량) 목록을 입력하여 주문할 수 있어야 합니다.
```mermaid
stateDiagram-v2
    [*] --> 주문요청: 주문 요청
    
    주문요청 --> 사용자검증: 사용자 계정 상태 확인
    사용자검증 --> 주문실패: 정지 계정 또는 탈퇴 계정
    주문실패 --> [*]: 주문 불가

    사용자검증 --> 상품검증: 상품 목록 개별 확인
    상품검증 --> 재고확인: 각 상품 재고 체크
    
    
    재고확인 --> 주문불가상품: 재고 부족 상품 발견
    재고확인 --> 주문결정: 주문 가능
    주문불가상품 --> 부분주문결정: 부분 주문 가능 여부 확인
    부분주문결정 --> 상품검증: 일부 상품만 주문 진행
    부분주문결정 --> 주문실패: 모든 상품이 재고 부족
    주문실패 --> [*]: 주문 불가

    주문결정 --> 총액계산: 상품 가격 × 수량으로 총 주문 금액 산출
    총액계산 --> 쿠폰검증: 유효한 쿠폰이 있는가?
    
    쿠폰검증 --> 할인적용: 쿠폰 할인 금액 차감
    할인적용 --> 주문성공
    쿠폰검증 --> 주문성공: 쿠폰 없음 (할인 없음)

    주문성공 --> [*]: 주문 완료
```

<br>

### 4-2. 주문 시 결제는 기존에 충전된 잔액을 사용하여 수행합니다. 결제 성공 시 잔액이 차감되어야 합니다.
```mermaid
stateDiagram-v2
    [*] --> 결제요청: 결제 요청

    결제요청 --> 잔액확인: 사용자 잔액 조회
    잔액확인 --> 결제실패: 잔액 부족
    결제실패 --> [*]: 결제 실패 처리

    잔액확인 --> 결제진행: 잔액 충분
    결제진행 --> 포인트검증: 포인트 검증 요청
    포인트검증 --> 차감완료: 잔액 차감 성공
    차감완료 --> 결제성공: 결제 승인
    결제성공 --> 쿠폰사용처리: 쿠폰 상태 '사용'으로 업데이트
    쿠폰사용처리 --> 주문완료: 주문 확정

    주문완료 --> [*]: 주문 완료
```


<br>

### 4-3. 결제 성공 시 주문 정보를 외부 데이터 플랫폼으로 전송합니다.
```mermaid
stateDiagram-v2
    [*] --> 결제성공

    결제성공 --> 데이터전송: 외부 데이터 플랫폼으로 주문 정보 전송
    데이터전송 --> 전송완료: 전송 성공
    데이터전송 --> 전송실패: 전송 오류 발생
    전송실패 --> 재시도결정: 재시도 가능 여부 확인
    재시도결정 --> 데이터전송: 재시도 수행
    재시도결정 --> 전송포기: 최대 재시도 초과
    전송포기 --> [*]: 주문 정보 전송 실패 처리

    전송완료 --> [*]: 주문 정보 전송 완료
```


<br>

## 5. 상위 상품 조회 API
### 5-1. 최근 3일간 가장 많이 팔린 상위 5개 상품 정보를 제공합니다.
```mermaid
stateDiagram-v2
    [*] --> 배치시작: 배치 프로세스 실행 (주기적 실행)

    배치시작 --> 주문조회: 최근 3일간 주문 데이터 조회
    주문조회 --> 결제검증: 결제 완료된 주문만 필터링
    결제검증 --> 통계집계: 상품별 판매 개수 계산

    통계집계 --> 정렬처리: 판매 개수 기준 정렬
    정렬처리 --> 동률검사: 동일 판매 개수 발생 여부 확인
    동률검사 --> 추가정렬: 상품 ID 기준 정렬 (동률 발생 시)
    동률검사 --> 상위5개선정: 동률이 없으면 바로 상위 5개 선정

    추가정렬 --> 상위5개선정: 동률 정렬 후 상위 5개 선정
    상위5개선정 --> 데이터저장: 상품통계저장소에 결과 저장
    데이터저장 --> [*]: 배치 완료
```